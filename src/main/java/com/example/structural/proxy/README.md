# ä»£ç†æ¨¡å¼ï¼ˆProxy Patternï¼‰â€”â€” Station ç¤ºä¾‹å®Œæ•´æ•´ç†

> ç›®æ ‡ï¼šä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚  
> ä½ ä¼šåœ¨ï¼šéœ€è¦åœ¨ä¸ä¿®æ”¹åŸå§‹å¯¹è±¡çš„æƒ…å†µä¸‹å¢å¼ºåŠŸèƒ½ã€æ§åˆ¶è®¿é—®ã€å»¶è¿ŸåŠ è½½ã€è¿œç¨‹ä»£ç†ã€è™šæ‹Ÿä»£ç†ç­‰åœºæ™¯ä¸­é‡åˆ°å®ƒã€‚

æœ¬æ–‡é€šè¿‡ Stationï¼ˆç«è½¦ç«™å–ç¥¨ï¼‰ç¤ºä¾‹ï¼Œè®²è§£ä¸‰ç§ä»£ç†å®ç°æ–¹å¼ï¼š

**é™æ€ä»£ç† â†’ JDK åŠ¨æ€ä»£ç† â†’ CGLIB åŠ¨æ€ä»£ç†**

é‡ç‚¹å›ç­”ä¸¤ä¸ªé—®é¢˜ï¼š

1. ä¸ºä»€ä¹ˆè¦å¼•å…¥ä¸‹ä¸€ç§ä»£ç†æ–¹å¼
2. å®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Œåˆå¼•å…¥äº†ä»€ä¹ˆä»£ä»·

---

## 1. ä¸ºä»€ä¹ˆéœ€è¦ä»£ç†æ¨¡å¼

### 1.1 å…¸å‹åœºæ™¯

- **åŠŸèƒ½å¢å¼º**ï¼šåœ¨ä¸ä¿®æ”¹åŸå§‹ç±»çš„æƒ…å†µä¸‹ï¼Œæ·»åŠ æ—¥å¿—ã€äº‹åŠ¡ã€æƒé™æ£€æŸ¥ç­‰åŠŸèƒ½
- **è®¿é—®æ§åˆ¶**ï¼šæ§åˆ¶å¯¹ç›®æ ‡å¯¹è±¡çš„è®¿é—®ï¼Œå¦‚æƒé™éªŒè¯ã€ç¼“å­˜ç­‰
- **å»¶è¿ŸåŠ è½½**ï¼šå»¶è¿Ÿåˆ›å»ºæ˜‚è´µçš„å¯¹è±¡ï¼Œç›´åˆ°çœŸæ­£éœ€è¦æ—¶æ‰åˆ›å»º
- **è¿œç¨‹ä»£ç†**ï¼šä¸ºè¿œç¨‹å¯¹è±¡æä¾›æœ¬åœ°ä»£è¡¨ï¼Œéšè—ç½‘ç»œé€šä¿¡ç»†èŠ‚
- **è™šæ‹Ÿä»£ç†**ï¼šä¸ºåˆ›å»ºå¼€é”€å¤§çš„å¯¹è±¡æä¾›å ä½ç¬¦

### 1.2 ä»£ç†æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³

```
å®¢æˆ·ç«¯ â†’ ä»£ç†å¯¹è±¡ â†’ çœŸå®å¯¹è±¡
```

ä»£ç†å¯¹è±¡åœ¨å®¢æˆ·ç«¯å’ŒçœŸå®å¯¹è±¡ä¹‹é—´èµ·åˆ°ä¸­ä»‹ä½œç”¨ï¼Œå¯ä»¥ï¼š
- åœ¨è°ƒç”¨çœŸå®å¯¹è±¡çš„æ–¹æ³•å‰åæ·»åŠ é¢å¤–é€»è¾‘
- æ§åˆ¶å¯¹çœŸå®å¯¹è±¡çš„è®¿é—®
- å®Œå…¨æ›¿ä»£çœŸå®å¯¹è±¡ï¼ˆå®¢æˆ·ç«¯æ— éœ€çŸ¥é“çœŸå®å¯¹è±¡çš„å­˜åœ¨ï¼‰

---

## 2. ä»£ç†æ¨¡å¼å®ç°æ–¹å¼æ€»è§ˆ

| å®ç°æ–¹å¼     | ä¼˜ç‚¹                           | ç¼ºç‚¹                           | é€‚ç”¨åœºæ™¯                     |
| ------------ | ------------------------------ | ------------------------------ | ---------------------------- |
| é™æ€ä»£ç†     | ç®€å•ç›´è§‚ã€æ€§èƒ½å¥½               | ä»£ç†ç±»å¤šã€ç»´æŠ¤æˆæœ¬é«˜           | ä»£ç†ç±»å°‘ã€åŠŸèƒ½å›ºå®š           |
| JDK åŠ¨æ€ä»£ç† | æ— éœ€æ‰‹åŠ¨åˆ›å»ºä»£ç†ç±»ã€çµæ´»       | åªèƒ½ä»£ç†æ¥å£ã€éœ€è¦æ¥å£         | æœ‰æ¥å£ã€éœ€è¦è¿è¡Œæ—¶åŠ¨æ€ä»£ç†   |
| CGLIB åŠ¨æ€ä»£ç† | å¯ä»¥ä»£ç†ç±»ã€æ— éœ€æ¥å£           | ä¸èƒ½ä»£ç† final ç±»/æ–¹æ³•ã€æ€§èƒ½ç•¥ä½ | æ— æ¥å£ã€éœ€è¦ä»£ç†ç±»           |

---

## 3. é™æ€ä»£ç†ï¼ˆStatic Proxyï¼‰

### 3.1 æ ¸å¿ƒæ€æƒ³

ğŸ‘‰ æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªä»£ç†ç±»ï¼Œå®ç°ä¸è¢«ä»£ç†å¯¹è±¡ç›¸åŒçš„æ¥å£ï¼Œåœ¨ä»£ç†ç±»ä¸­è°ƒç”¨çœŸå®å¯¹è±¡çš„æ–¹æ³•ã€‚

### 3.2 ç¤ºä¾‹ä»£ç 

**æ¥å£å®šä¹‰ï¼š**

```java
public interface SellTickets {
    void sell();
}
```

**çœŸå®å¯¹è±¡ï¼š**

```java
public class Station implements SellTickets {
    @Override
    public void sell() {
        System.out.println("ç«è½¦ç«™å–ç¥¨");
    }
}
```

**ä»£ç†ç±»ï¼š**

```java
public class ProxyPoint implements SellTickets {
    private Station station;

    public ProxyPoint(Station station) {
        this.station = station;
    }

    @Override
    public void sell() {
        System.out.println("ä»£ç†ç‚¹æ”¶å–æœåŠ¡è´¹");
        station.sell();
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```java
public class Client {
    public static void main(String[] args) {
        ProxyPoint proxyPoint = new ProxyPoint(new Station());
        proxyPoint.sell();
    }
}
```

### 3.3 é™æ€ä»£ç†çš„ç‰¹ç‚¹

**ä¼˜ç‚¹ï¼š**
- âœ… å®ç°ç®€å•ï¼Œæ˜“äºç†è§£
- âœ… æ€§èƒ½å¥½ï¼Œæ— åå°„å¼€é”€
- âœ… ç¼–è¯‘æ—¶ç¡®å®šï¼Œç±»å‹å®‰å…¨

**ç¼ºç‚¹ï¼š**
- âŒ ä»£ç†ç±»æ•°é‡å¤šï¼šæ¯ä¸ªè¢«ä»£ç†ç±»éƒ½éœ€è¦ä¸€ä¸ªä»£ç†ç±»
- âŒ ç»´æŠ¤æˆæœ¬é«˜ï¼šæ¥å£å˜åŒ–æ—¶ï¼Œä»£ç†ç±»ä¹Ÿéœ€è¦ä¿®æ”¹
- âŒ ä»£ç é‡å¤ï¼šå¤šä¸ªä»£ç†ç±»å¯èƒ½æœ‰ç›¸ä¼¼çš„å¢å¼ºé€»è¾‘

### 3.4 é€‚ç”¨åœºæ™¯

- ä»£ç†ç±»æ•°é‡å°‘
- åŠŸèƒ½ç›¸å¯¹å›ºå®š
- å¯¹æ€§èƒ½è¦æ±‚é«˜

---

## 4. JDK åŠ¨æ€ä»£ç†ï¼ˆJDK Dynamic Proxyï¼‰

### 4.1 ä¸ºä»€ä¹ˆå¼•å…¥ JDK åŠ¨æ€ä»£ç†

é™æ€ä»£ç†çš„é—®é¢˜æœ¬è´¨æ˜¯ï¼š
- éœ€è¦ä¸ºæ¯ä¸ªè¢«ä»£ç†ç±»æ‰‹åŠ¨åˆ›å»ºä»£ç†ç±»
- ä»£ç†ç±»ä»£ç é‡å¤

JDK åŠ¨æ€ä»£ç†é€šè¿‡**åå°„æœºåˆ¶**åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä»£ç†ç±»ï¼Œæ— éœ€æ‰‹åŠ¨ç¼–å†™ä»£ç†ç±»ä»£ç ã€‚

### 4.2 æ ¸å¿ƒæœºåˆ¶

**å…³é”®ç±»ï¼š**
- `java.lang.reflect.Proxy`ï¼šç”¨äºåˆ›å»ºåŠ¨æ€ä»£ç†ç±»
- `java.lang.reflect.InvocationHandler`ï¼šè°ƒç”¨å¤„ç†å™¨æ¥å£

**å·¥ä½œåŸç†ï¼š**
1. åŠ¨æ€ä»£ç†ç±»åœ¨å†…å­˜ä¸­ç”Ÿæˆï¼Œç»§æ‰¿ `Proxy` ç±»ï¼Œå®ç°è¢«ä»£ç†å¯¹è±¡çš„æ¥å£
2. åŠ¨æ€ä»£ç†ç±»çš„æ–¹æ³•è°ƒç”¨ä¼šè½¬å‘åˆ° `InvocationHandler.invoke()` æ–¹æ³•
3. åœ¨ `invoke()` æ–¹æ³•ä¸­ï¼Œé€šè¿‡åå°„è°ƒç”¨çœŸå®å¯¹è±¡çš„æ–¹æ³•

### 4.3 ç¤ºä¾‹ä»£ç 

**ä»£ç†å·¥å‚ï¼š**

```java
public class ProxyFactory {
    private Station station;

    public ProxyFactory(Station station) {
        this.station = station;
    }

    public SellTickets getSellTickets() {
        /*
         * Proxy.newProxyInstance å‚æ•°è¯´æ˜ï¼š
         * - ClassLoader loader: ç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½ä»£ç†ç±»
         * - Class<?>[] interfaces: ä»£ç†ç±»å®ç°çš„æ¥å£å­—èŠ‚ç å¯¹è±¡
         * - InvocationHandler h: ä»£ç†å¯¹è±¡çš„è°ƒç”¨å¤„ç†ç¨‹åº
         */
        SellTickets proxy = (SellTickets) Proxy.newProxyInstance(
            station.getClass().getClassLoader(),
            station.getClass().getInterfaces(),
            new InvocationHandler() {
                /**
                 * @param proxy è¢«ä»£ç†çš„å¯¹è±¡ï¼Œç­‰åŒäº newProxyInstance è¿”å›çš„å¯¹è±¡
                 * @param method è¢«è°ƒç”¨çš„æ–¹æ³•å¯¹è±¡
                 * @param args æ–¹æ³•çš„æ‰§è¡Œå‚æ•°
                 * @return æ–¹æ³•çš„è¿”å›å€¼
                 */
                @Override
                public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
                    System.out.println("ä»£ç†ç‚¹æ”¶å–æœåŠ¡è´¹");
                    Object result = method.invoke(station, args);
                    return result;
                }
            }
        );
        return proxy;
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```java
public class Client {
    public static void main(String[] args) {
        ProxyFactory proxyFactory = new ProxyFactory(new Station());
        SellTickets sellTickets = proxyFactory.getSellTickets();
        sellTickets.sell();
    }
}
```

### 4.4 æ‰§è¡Œæµç¨‹

1. é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨ `sell()` æ–¹æ³•
2. ç”±äº `sellTickets` æŒ‡å‘çš„æ˜¯åŠ¨æ€ç”Ÿæˆçš„ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œä»£ç†ç±»ä¸­çš„ `sell()` æ–¹æ³•
3. ä»£ç†ç±»ä¸­çš„ `sell()` æ–¹æ³•ä¼šè°ƒç”¨ä¼ å…¥çš„ `InvocationHandler` å®ç°ç±»ï¼ˆåŒ¿åå†…éƒ¨ç±»ï¼‰çš„ `invoke()` æ–¹æ³•
4. `invoke()` æ–¹æ³•é€šè¿‡åå°„æ‰§è¡ŒçœŸå®å¯¹è±¡ `Station` ä¸­çš„ `sell()` æ–¹æ³•

### 4.5 JDK åŠ¨æ€ä»£ç†çš„ç‰¹ç‚¹

**ä¼˜ç‚¹ï¼š**
- âœ… æ— éœ€æ‰‹åŠ¨åˆ›å»ºä»£ç†ç±»ï¼Œå‡å°‘ä»£ç é‡
- âœ… çµæ´»ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºä»£ç†
- âœ… ç»Ÿä¸€å¤„ç†å¤šä¸ªæ–¹æ³•ï¼Œå‡å°‘é‡å¤ä»£ç 

**ç¼ºç‚¹ï¼š**
- âŒ åªèƒ½ä»£ç†æ¥å£ï¼Œä¸èƒ½ä»£ç†ç±»
- âŒ éœ€è¦è¢«ä»£ç†å¯¹è±¡å®ç°æ¥å£
- âŒ åå°„è°ƒç”¨æœ‰æ€§èƒ½å¼€é”€ï¼ˆé€šå¸¸å¯å¿½ç•¥ï¼‰

### 4.6 é€‚ç”¨åœºæ™¯

- è¢«ä»£ç†å¯¹è±¡å®ç°äº†æ¥å£
- éœ€è¦è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºä»£ç†
- éœ€è¦ç»Ÿä¸€å¤„ç†å¤šä¸ªæ–¹æ³•

---

## 5. CGLIB åŠ¨æ€ä»£ç†ï¼ˆCGLIB Dynamic Proxyï¼‰

### 5.1 ä¸ºä»€ä¹ˆå¼•å…¥ CGLIB åŠ¨æ€ä»£ç†

JDK åŠ¨æ€ä»£ç†çš„é™åˆ¶ï¼š
- åªèƒ½ä»£ç†æ¥å£
- å¦‚æœè¢«ä»£ç†å¯¹è±¡æ²¡æœ‰å®ç°æ¥å£ï¼Œæ— æ³•ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†

CGLIB é€šè¿‡**å­—èŠ‚ç æŠ€æœ¯**åœ¨è¿è¡Œæ—¶ç”Ÿæˆè¢«ä»£ç†ç±»çš„å­ç±»ï¼Œå› æ­¤å¯ä»¥ä»£ç†æ²¡æœ‰æ¥å£çš„ç±»ã€‚

### 5.2 æ ¸å¿ƒæœºåˆ¶

**å…³é”®ç±»ï¼š**
- `net.sf.cglib.proxy.Enhancer`ï¼šç”¨äºåˆ›å»ºåŠ¨æ€ä»£ç†ç±»
- `net.sf.cglib.proxy.MethodInterceptor`ï¼šæ–¹æ³•æ‹¦æˆªå™¨æ¥å£

**å·¥ä½œåŸç†ï¼š**
1. CGLIB åœ¨è¿è¡Œæ—¶ç”Ÿæˆè¢«ä»£ç†ç±»çš„å­ç±»
2. å­ç±»é‡å†™çˆ¶ç±»çš„æ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­è°ƒç”¨ `MethodInterceptor.intercept()`
3. åœ¨ `intercept()` æ–¹æ³•ä¸­ï¼Œé€šè¿‡ `MethodProxy.invokeSuper()` è°ƒç”¨çˆ¶ç±»æ–¹æ³•

### 5.3 ç¤ºä¾‹ä»£ç 

**ä»£ç†å·¥å‚ï¼š**

```java
public class ProxyFactory {
    public Station getStation() {
        Enhancer enhancer = new Enhancer(); // åˆ›å»ºå¢å¼ºå™¨
        enhancer.setSuperclass(Station.class); // è®¾ç½®çˆ¶ç±»
        enhancer.setCallback(new MethodInterceptor() {
            /**
             * @param obj è¢«ä»£ç†çš„å¯¹è±¡ï¼ˆä»£ç†å¯¹è±¡æœ¬èº«ï¼‰
             * @param method è¢«ä»£ç†çš„æ–¹æ³•
             * @param args æ–¹æ³•çš„å‚æ•°
             * @param proxy æ–¹æ³•ä»£ç†ï¼Œç”¨äºè°ƒç”¨çˆ¶ç±»æ–¹æ³•
             * @return æ–¹æ³•çš„è¿”å›å€¼
             */
            @Override
            public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable {
                System.out.println("ä»£ç†ç‚¹æ”¶å–æœåŠ¡è´¹");
                return proxy.invokeSuper(obj, args); // è°ƒç”¨çˆ¶ç±»æ–¹æ³•
            }
        });
        return (Station) enhancer.create(); // åˆ›å»ºä»£ç†å¯¹è±¡å¹¶è¿”å›
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```java
public class Client {
    public static void main(String[] args) {
        ProxyFactory proxyFactory = new ProxyFactory();
        Station station = proxyFactory.getStation();
        station.sell();
    }
}
```

### 5.4 æ³¨æ„äº‹é¡¹

**Java 9+ è¿è¡Œé…ç½®ï¼š**

CGLIB éœ€è¦è®¿é—® Java å†…éƒ¨ APIï¼Œåœ¨ Java 9+ ä¸­éœ€è¦æ·»åŠ  JVM å‚æ•°ï¼š

```
--add-opens java.base/java.lang=ALL-UNNAMED
```

**IDE è¿è¡Œé…ç½®ï¼š**
- IntelliJ IDEA: `Run` â†’ `Edit Configurations` â†’ `VM options`: `--add-opens java.base/java.lang=ALL-UNNAMED`
- Eclipse: `Run` â†’ `Run Configurations` â†’ `Arguments` â†’ `VM arguments`: `--add-opens java.base/java.lang=ALL-UNNAMED`

**å‘½ä»¤è¡Œè¿è¡Œï¼š**

```bash
MAVEN_OPTS="--add-opens java.base/java.lang=ALL-UNNAMED" mvn exec:java -Dexec.mainClass="com.example.structural.proxy.cglib.Client"
```

### 5.5 CGLIB åŠ¨æ€ä»£ç†çš„ç‰¹ç‚¹

**ä¼˜ç‚¹ï¼š**
- âœ… å¯ä»¥ä»£ç†ç±»ï¼Œæ— éœ€æ¥å£
- âœ… æ€§èƒ½æ¯” JDK åŠ¨æ€ä»£ç†ç•¥å¥½ï¼ˆå­—èŠ‚ç æŠ€æœ¯ï¼‰
- âœ… åŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒæ–¹æ³•æ‹¦æˆªã€å­—æ®µæ‹¦æˆªç­‰

**ç¼ºç‚¹ï¼š**
- âŒ ä¸èƒ½ä»£ç† `final` ç±»æˆ– `final` æ–¹æ³•
- âŒ ä¸èƒ½ä»£ç† `private` æ–¹æ³•
- âŒ éœ€è¦é¢å¤–çš„ä¾èµ–ï¼ˆCGLIB åº“ï¼‰
- âŒ Java 9+ éœ€è¦é¢å¤–çš„ JVM å‚æ•°

### 5.6 é€‚ç”¨åœºæ™¯

- è¢«ä»£ç†å¯¹è±¡æ²¡æœ‰å®ç°æ¥å£
- éœ€è¦ä»£ç†ç±»è€Œä¸æ˜¯æ¥å£
- å¯¹æ€§èƒ½æœ‰ä¸€å®šè¦æ±‚

---

## 6. ä»£ç ç»“æ„

æœ¬ç¤ºä¾‹åŒ…å«ä»¥ä¸‹ç›®å½•ç»“æ„ï¼š

```
proxy/
â”œâ”€â”€ staticproxy/    # é™æ€ä»£ç†
â”‚   â”œâ”€â”€ SellTickets.java    # æ¥å£
â”‚   â”œâ”€â”€ Station.java        # çœŸå®å¯¹è±¡
â”‚   â”œâ”€â”€ ProxyPoint.java     # ä»£ç†ç±»
â”‚   â””â”€â”€ Client.java         # å®¢æˆ·ç«¯
â”œâ”€â”€ jdk/            # JDK åŠ¨æ€ä»£ç†
â”‚   â”œâ”€â”€ SellTickets.java    # æ¥å£
â”‚   â”œâ”€â”€ Station.java        # çœŸå®å¯¹è±¡ï¼ˆå®ç°æ¥å£ï¼‰
â”‚   â”œâ”€â”€ ProxyFactory.java   # ä»£ç†å·¥å‚
â”‚   â””â”€â”€ Client.java         # å®¢æˆ·ç«¯
â””â”€â”€ cglib/          # CGLIB åŠ¨æ€ä»£ç†
    â”œâ”€â”€ Station.java        # çœŸå®å¯¹è±¡ï¼ˆæ— éœ€æ¥å£ï¼‰
    â”œâ”€â”€ ProxyFactory.java   # ä»£ç†å·¥å‚
    â””â”€â”€ Client.java         # å®¢æˆ·ç«¯
```

---

## 7. UML ç±»å›¾

### 7.1 é™æ€ä»£ç†

```mermaid
classDiagram
class SellTickets {
    <<interface>>
    +sell()
}
class Station {
    +sell()
}
class ProxyPoint {
    -Station station
    +sell()
}
class Client {
    +main(String[])
}

SellTickets <|.. Station
SellTickets <|.. ProxyPoint
ProxyPoint --> Station : uses
Client ..> ProxyPoint : uses
```

### 7.2 JDK åŠ¨æ€ä»£ç†

```mermaid
classDiagram
class SellTickets {
    <<interface>>
    +sell()
}
class Station {
    +sell()
}
class ProxyFactory {
    -Station station
    +getSellTickets() SellTickets
}
class InvocationHandler {
    <<interface>>
    +invoke(Object, Method, Object[]) Object
}
class Client {
    +main(String[])
}

SellTickets <|.. Station
ProxyFactory ..> Proxy : uses
ProxyFactory ..> InvocationHandler : uses
InvocationHandler ..> Station : invokes
Client ..> ProxyFactory : uses
Client --> SellTickets : uses
```

### 7.3 CGLIB åŠ¨æ€ä»£ç†

```mermaid
classDiagram
class Station {
    +sell()
}
class ProxyFactory {
    +getStation() Station
}
class MethodInterceptor {
    <<interface>>
    +intercept(Object, Method, Object[], MethodProxy) Object
}
class Enhancer {
    +setSuperclass(Class)
    +setCallback(Callback)
    +create() Object
}
class Client {
    +main(String[])
}

ProxyFactory ..> Enhancer : uses
ProxyFactory ..> MethodInterceptor : uses
MethodInterceptor ..> Station : invokes
Enhancer ..> Station : extends
Client ..> ProxyFactory : uses
Client --> Station : uses
```

### 7.4 PlantUML ç±»å›¾

#### é™æ€ä»£ç†

```plantuml
@startuml
interface SellTickets {
  + sell()
}

class Station {
  + sell()
}

class ProxyPoint {
  - station : Station
  + sell()
}

class Client {
  + main(String[])
}

SellTickets <|.. Station
SellTickets <|.. ProxyPoint
ProxyPoint --> Station : uses
Client ..> ProxyPoint : uses
@enduml
```

#### JDK åŠ¨æ€ä»£ç†

```plantuml
@startuml
interface SellTickets {
  + sell()
}

class Station {
  + sell()
}

class ProxyFactory {
  - station : Station
  + getSellTickets() : SellTickets
}

interface InvocationHandler {
  + invoke(Object, Method, Object[]) : Object
}

class Client {
  + main(String[])
}

SellTickets <|.. Station
ProxyFactory ..> InvocationHandler : uses
InvocationHandler ..> Station : invokes
Client ..> ProxyFactory : uses
Client --> SellTickets : uses
@enduml
```

#### CGLIB åŠ¨æ€ä»£ç†

```plantuml
@startuml
class Station {
  + sell()
}

class ProxyFactory {
  + getStation() : Station
}

interface MethodInterceptor {
  + intercept(Object, Method, Object[], MethodProxy) : Object
}

class Enhancer {
  + setSuperclass(Class)
  + setCallback(Callback)
  + create() : Object
}

class Client {
  + main(String[])
}

ProxyFactory ..> Enhancer : uses
ProxyFactory ..> MethodInterceptor : uses
MethodInterceptor ..> Station : invokes
Enhancer ..> Station : extends
Client ..> ProxyFactory : uses
Client --> Station : uses
@enduml
```

---

## 8. ä¸‰ç§ä»£ç†æ–¹å¼å¯¹æ¯”

### 8.1 åŠŸèƒ½å¯¹æ¯”

| ç‰¹æ€§           | é™æ€ä»£ç† | JDK åŠ¨æ€ä»£ç† | CGLIB åŠ¨æ€ä»£ç† |
| -------------- | -------- | ------------ | ------------- |
| ä»£ç†æ¥å£       | âœ…       | âœ…           | âŒ            |
| ä»£ç†ç±»         | âœ…       | âŒ           | âœ…            |
| ç¼–è¯‘æ—¶ç¡®å®š     | âœ…       | âŒ           | âŒ            |
| è¿è¡Œæ—¶ç”Ÿæˆ     | âŒ       | âœ…           | âœ…            |
| éœ€è¦æ¥å£       | âœ…       | âœ…           | âŒ            |
| ä»£ç† final ç±»  | âœ…       | âŒ           | âŒ            |
| æ€§èƒ½           | æœ€å¥½     | ä¸­ç­‰         | è¾ƒå¥½          |
| ä»£ç é‡         | å¤š       | å°‘           | å°‘            |

### 8.2 ä½¿ç”¨åœºæ™¯å¯¹æ¯”

**é™æ€ä»£ç†ï¼š**
- ä»£ç†ç±»æ•°é‡å°‘
- åŠŸèƒ½ç›¸å¯¹å›ºå®š
- å¯¹æ€§èƒ½è¦æ±‚é«˜

**JDK åŠ¨æ€ä»£ç†ï¼š**
- è¢«ä»£ç†å¯¹è±¡å®ç°äº†æ¥å£
- éœ€è¦è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºä»£ç†
- éœ€è¦ç»Ÿä¸€å¤„ç†å¤šä¸ªæ–¹æ³•

**CGLIB åŠ¨æ€ä»£ç†ï¼š**
- è¢«ä»£ç†å¯¹è±¡æ²¡æœ‰å®ç°æ¥å£
- éœ€è¦ä»£ç†ç±»è€Œä¸æ˜¯æ¥å£
- å¯¹æ€§èƒ½æœ‰ä¸€å®šè¦æ±‚

---

## 9. ä½¿ç”¨åœºæ™¯

### 9.1 é€‚ç”¨åœºæ™¯

- âœ… **åŠŸèƒ½å¢å¼º**ï¼šæ—¥å¿—è®°å½•ã€æ€§èƒ½ç›‘æ§ã€äº‹åŠ¡ç®¡ç†
- âœ… **è®¿é—®æ§åˆ¶**ï¼šæƒé™éªŒè¯ã€ç¼“å­˜ã€é™æµ
- âœ… **å»¶è¿ŸåŠ è½½**ï¼šå»¶è¿Ÿåˆ›å»ºæ˜‚è´µçš„å¯¹è±¡
- âœ… **è¿œç¨‹ä»£ç†**ï¼šRPC æ¡†æ¶ã€åˆ†å¸ƒå¼ç³»ç»Ÿ
- âœ… **è™šæ‹Ÿä»£ç†**ï¼šå›¾ç‰‡æ‡’åŠ è½½ã€å¤§å¯¹è±¡ä»£ç†

### 9.2 å¸¸è§åº”ç”¨

- **Spring AOP**ï¼šä½¿ç”¨ JDK åŠ¨æ€ä»£ç†å’Œ CGLIB å®ç°é¢å‘åˆ‡é¢ç¼–ç¨‹
- **MyBatis**ï¼šä½¿ç”¨ JDK åŠ¨æ€ä»£ç†å®ç° Mapper æ¥å£ä»£ç†
- **Hibernate**ï¼šä½¿ç”¨ CGLIB å®ç°å»¶è¿ŸåŠ è½½
- **RPC æ¡†æ¶**ï¼šä½¿ç”¨åŠ¨æ€ä»£ç†å®ç°è¿œç¨‹è°ƒç”¨
- **æ—¥å¿—æ¡†æ¶**ï¼šä½¿ç”¨ä»£ç†å®ç°æ—¥å¿—è®°å½•

---

## 10. ä¼˜ç¼ºç‚¹åˆ†æ

### 10.1 ä»£ç†æ¨¡å¼çš„ä¼˜ç‚¹

- âœ… **è§£è€¦**ï¼šå®¢æˆ·ç«¯ä¸çœŸå®å¯¹è±¡è§£è€¦ï¼Œé€šè¿‡ä»£ç†å¯¹è±¡è®¿é—®
- âœ… **å¢å¼ºåŠŸèƒ½**ï¼šåœ¨ä¸ä¿®æ”¹åŸå§‹ç±»çš„æƒ…å†µä¸‹æ·»åŠ åŠŸèƒ½
- âœ… **æ§åˆ¶è®¿é—®**ï¼šå¯ä»¥æ§åˆ¶å¯¹çœŸå®å¯¹è±¡çš„è®¿é—®
- âœ… **çµæ´»**ï¼šå¯ä»¥åŠ¨æ€åˆ›å»ºä»£ç†ï¼Œé€‚åº”ä¸åŒåœºæ™¯

### 10.2 ä»£ç†æ¨¡å¼çš„ç¼ºç‚¹

- âŒ **å¤æ‚åº¦å¢åŠ **ï¼šå¼•å…¥ä»£ç†å±‚ï¼Œå¢åŠ ç³»ç»Ÿå¤æ‚åº¦
- âŒ **æ€§èƒ½å¼€é”€**ï¼šåŠ¨æ€ä»£ç†æœ‰åå°„æˆ–å­—èŠ‚ç ç”Ÿæˆçš„å¼€é”€
- âŒ **è°ƒè¯•å›°éš¾**ï¼šåŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»éš¾ä»¥è°ƒè¯•

---

## 11. ä¸å…¶ä»–æ¨¡å¼çš„å…³ç³»

### 11.1 ä¸è£…é¥°å™¨æ¨¡å¼çš„åŒºåˆ«

- **ä»£ç†æ¨¡å¼**ï¼šæ§åˆ¶å¯¹å¯¹è±¡çš„è®¿é—®ï¼Œä»£ç†å¯¹è±¡å’Œè¢«ä»£ç†å¯¹è±¡æ˜¯åŒä¸€ä¸ªæ¥å£
- **è£…é¥°å™¨æ¨¡å¼**ï¼šå¢å¼ºå¯¹è±¡çš„åŠŸèƒ½ï¼Œå¯ä»¥åŠ¨æ€æ·»åŠ å¤šä¸ªè£…é¥°å™¨

**åŒºåˆ«ï¼š**
- ä»£ç†æ¨¡å¼ï¼šä»£ç†å¯¹è±¡æ§åˆ¶è®¿é—®ï¼Œé€šå¸¸åªæœ‰ä¸€ä¸ªä»£ç†
- è£…é¥°å™¨æ¨¡å¼ï¼šå¯ä»¥å åŠ å¤šä¸ªè£…é¥°å™¨ï¼ŒåŠŸèƒ½å åŠ 

### 11.2 ä¸é€‚é…å™¨æ¨¡å¼çš„åŒºåˆ«

- **ä»£ç†æ¨¡å¼**ï¼šä»£ç†å¯¹è±¡å’Œè¢«ä»£ç†å¯¹è±¡å®ç°ç›¸åŒçš„æ¥å£
- **é€‚é…å™¨æ¨¡å¼**ï¼šé€‚é…å™¨å¯¹è±¡å°†ä¸å…¼å®¹çš„æ¥å£è½¬æ¢ä¸ºå…¼å®¹çš„æ¥å£

**åŒºåˆ«ï¼š**
- ä»£ç†æ¨¡å¼ï¼šæ¥å£ç›¸åŒï¼Œæ§åˆ¶è®¿é—®
- é€‚é…å™¨æ¨¡å¼ï¼šæ¥å£ä¸åŒï¼Œè½¬æ¢æ¥å£

### 11.3 ä¸å¤–è§‚æ¨¡å¼çš„åŒºåˆ«

- **ä»£ç†æ¨¡å¼**ï¼šä»£ç†ä¸€ä¸ªå¯¹è±¡ï¼Œæ§åˆ¶å¯¹å•ä¸ªå¯¹è±¡çš„è®¿é—®
- **å¤–è§‚æ¨¡å¼**ï¼šä¸ºå¤šä¸ªå­ç³»ç»Ÿæä¾›ç»Ÿä¸€çš„æ¥å£

**åŒºåˆ«ï¼š**
- ä»£ç†æ¨¡å¼ï¼šä¸€å¯¹ä¸€çš„å…³ç³»
- å¤–è§‚æ¨¡å¼ï¼šä¸€å¯¹å¤šçš„å…³ç³»

---

## 12. é¢è¯•è¦ç‚¹

### 12.1 åŸºç¡€é—®é¢˜

- **ä»£ç†æ¨¡å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ**
  - è¦ç‚¹ï¼šæ§åˆ¶å¯¹å¯¹è±¡çš„è®¿é—®ï¼Œåœ¨ä¸ä¿®æ”¹åŸå§‹ç±»çš„æƒ…å†µä¸‹å¢å¼ºåŠŸèƒ½

- **é™æ€ä»£ç†ã€JDK åŠ¨æ€ä»£ç†ã€CGLIB åŠ¨æ€ä»£ç†çš„åŒºåˆ«ï¼Ÿ**
  - è¦ç‚¹ï¼šé™æ€ä»£ç†æ‰‹åŠ¨åˆ›å»ºï¼›JDK åŠ¨æ€ä»£ç†åŸºäºæ¥å£ï¼›CGLIB åŠ¨æ€ä»£ç†åŸºäºç»§æ‰¿

- **JDK åŠ¨æ€ä»£ç†å’Œ CGLIB åŠ¨æ€ä»£ç†çš„åŒºåˆ«ï¼Ÿ**
  - è¦ç‚¹ï¼šJDK åŠ¨æ€ä»£ç†åªèƒ½ä»£ç†æ¥å£ï¼ŒCGLIB å¯ä»¥ä»£ç†ç±»ï¼›JDK ä½¿ç”¨åå°„ï¼ŒCGLIB ä½¿ç”¨å­—èŠ‚ç æŠ€æœ¯

### 12.2 å®ç°ç»†èŠ‚

- **JDK åŠ¨æ€ä»£ç†çš„å·¥ä½œåŸç†ï¼Ÿ**
  - è¦ç‚¹ï¼šè¿è¡Œæ—¶ç”Ÿæˆä»£ç†ç±»ï¼Œç»§æ‰¿ Proxy ç±»ï¼Œå®ç°è¢«ä»£ç†å¯¹è±¡çš„æ¥å£ï¼Œæ–¹æ³•è°ƒç”¨è½¬å‘åˆ° InvocationHandler

- **CGLIB åŠ¨æ€ä»£ç†çš„å·¥ä½œåŸç†ï¼Ÿ**
  - è¦ç‚¹ï¼šè¿è¡Œæ—¶ç”Ÿæˆè¢«ä»£ç†ç±»çš„å­ç±»ï¼Œé‡å†™æ–¹æ³•ï¼Œæ–¹æ³•è°ƒç”¨è½¬å‘åˆ° MethodInterceptor

- **ä¸ºä»€ä¹ˆ CGLIB ä¸èƒ½ä»£ç† final ç±»ï¼Ÿ**
  - è¦ç‚¹ï¼šCGLIB é€šè¿‡ç”Ÿæˆå­ç±»å®ç°ä»£ç†ï¼Œfinal ç±»ä¸èƒ½è¢«ç»§æ‰¿

### 12.3 å®è·µé—®é¢˜

- **Spring AOP å¦‚ä½•é€‰æ‹©ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†è¿˜æ˜¯ CGLIBï¼Ÿ**
  - è¦ç‚¹ï¼šå¦‚æœè¢«ä»£ç†å¯¹è±¡å®ç°äº†æ¥å£ï¼Œä¼˜å…ˆä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ï¼›å¦åˆ™ä½¿ç”¨ CGLIB

- **å¦‚ä½•ä¼˜åŒ–åŠ¨æ€ä»£ç†çš„æ€§èƒ½ï¼Ÿ**
  - è¦ç‚¹ï¼šç¼“å­˜ä»£ç†ç±»ã€å‡å°‘åå°„è°ƒç”¨ã€ä½¿ç”¨ CGLIB æ›¿ä»£ JDK åŠ¨æ€ä»£ç†ï¼ˆå¦‚æœä¸éœ€è¦æ¥å£ï¼‰

- **ä»£ç†æ¨¡å¼åœ¨å“ªäº›æ¡†æ¶ä¸­æœ‰åº”ç”¨ï¼Ÿ**
  - è¦ç‚¹ï¼šSpring AOPã€MyBatisã€Hibernateã€RPC æ¡†æ¶ç­‰

---

## 13. æ€»ç»“

ä»£ç†æ¨¡å¼æ˜¯ä¸€ä¸ª**éå¸¸å®ç”¨**çš„è®¾è®¡æ¨¡å¼ï¼Œå®ƒè§£å†³äº†å¯¹è±¡è®¿é—®æ§åˆ¶çš„æ ¸å¿ƒé—®é¢˜ï¼š

**æ ¸å¿ƒä»·å€¼ï¼š**

1. **è§£è€¦**ï¼šå®¢æˆ·ç«¯ä¸çœŸå®å¯¹è±¡è§£è€¦
2. **å¢å¼º**ï¼šåœ¨ä¸ä¿®æ”¹åŸå§‹ç±»çš„æƒ…å†µä¸‹å¢å¼ºåŠŸèƒ½
3. **æ§åˆ¶**ï¼šæ§åˆ¶å¯¹çœŸå®å¯¹è±¡çš„è®¿é—®
4. **çµæ´»**ï¼šå¯ä»¥åŠ¨æ€åˆ›å»ºä»£ç†ï¼Œé€‚åº”ä¸åŒåœºæ™¯

**æ¨¡å¼æ¼”è¿›ï¼š**

```
é™æ€ä»£ç†ï¼ˆæ‰‹åŠ¨åˆ›å»ºä»£ç†ç±»ï¼‰
  â†“ (é—®é¢˜ï¼šä»£ç†ç±»å¤šã€ç»´æŠ¤æˆæœ¬é«˜)
JDK åŠ¨æ€ä»£ç†ï¼ˆè¿è¡Œæ—¶ç”Ÿæˆä»£ç†ç±»ï¼ŒåŸºäºæ¥å£ï¼‰
  â†“ (é—®é¢˜ï¼šåªèƒ½ä»£ç†æ¥å£)
CGLIB åŠ¨æ€ä»£ç†ï¼ˆè¿è¡Œæ—¶ç”Ÿæˆå­ç±»ï¼ŒåŸºäºç»§æ‰¿ï¼‰
```

**æœ€ä½³å®è·µï¼š**

- ä»£ç†ç±»å°‘ä¸”å›ºå®šï¼šä½¿ç”¨é™æ€ä»£ç†
- æœ‰æ¥å£ä¸”éœ€è¦åŠ¨æ€ä»£ç†ï¼šä½¿ç”¨ JDK åŠ¨æ€ä»£ç†
- æ— æ¥å£ä¸”éœ€è¦åŠ¨æ€ä»£ç†ï¼šä½¿ç”¨ CGLIB åŠ¨æ€ä»£ç†
- æ¡†æ¶å¼€å‘ï¼šæ ¹æ®åœºæ™¯çµæ´»é€‰æ‹©

**ä¸€å¥è¯æ€»ç»“ï¼š**

> å½“éœ€è¦åœ¨è®¿é—®å¯¹è±¡æ—¶æ·»åŠ é¢å¤–åŠŸèƒ½æˆ–æ§åˆ¶è®¿é—®æ—¶ï¼Œç”¨ä»£ç†æ¨¡å¼åœ¨å®¢æˆ·ç«¯å’ŒçœŸå®å¯¹è±¡ä¹‹é—´æ·»åŠ ä¸€ä¸ªä¸­ä»‹å±‚ï¼Œè®©ä»£ç æ›´çµæ´»ã€æ›´æ˜“ç»´æŠ¤ã€‚
